const { GoogleGenerativeAI } = require("@google/generative-ai");
const Astrology = require("../models/astrology.model");
require("dotenv").config();

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

exports.generateAstrologyReport = async (req, res) => {
  const { name, birthDate, birthTime, birthPlace } = req.body;

  try {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

   const prompt = `
рдЖрдк рдПрдХ рдЕрдиреБрднрд╡реА рд╡реИрджрд┐рдХ рдЬреНрдпреЛрддрд┐рд╖рд╛рдЪрд╛рд░реНрдп рд╣реИрдВред рдХреГрдкрдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬрдиреНрдо рд╡рд┐рд╡рд░рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдФрд░ рд╕рдЯреАрдХ рд╡реИрджрд┐рдХ рдЬреНрдпреЛрддрд┐рд╖ рд░рд┐рдкреЛрд░реНрдЯ рд╣рд┐рдВрджреА рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд░реЗрдВред

ЁЯФ╣ рд╡рд┐рд╡рд░рдг:
- рдирд╛рдо: ${name}
- рдЬрдиреНрдо рддрд┐рдерд┐: ${birthDate}
- рдЬрдиреНрдо рд╕рдордп: ${birthTime}
- рдЬрдиреНрдо рд╕реНрдерд╛рди: ${birthPlace}

ЁЯФ╣ рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдмрд┐рдВрджреБрдУрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ:

1. **рджреЛрд╖реЛрдВ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг:**
   - рдХреНрдпрд╛ рдорд╛рдВрдЧрд▓рд┐рдХ рджреЛрд╖ рд╣реИ?
   - рдХреНрдпрд╛ рдХрд╛рд▓рд╕рд░реНрдк рджреЛрд╖ рдЙрдкрд╕реНрдерд┐рдд рд╣реИ?
   - рдХреНрдпрд╛ рдирд╛рдбрд╝реА рджреЛрд╖ рдпрд╛ рдкрд┐рддреГ рджреЛрд╖ рд╣реИ?
   - рдЗрди рджреЛрд╖реЛрдВ рдХреЗ рдкреНрд░рднрд╛рд╡ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рдкрд░рд┐рдгрд╛рдо рдХреНрдпрд╛ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ?

2. **рдпреЛрдЧ рдФрд░ рдХреБрдВрдбрд▓реА рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ:**
   - рд╕рдХрд╛рд░рд╛рддреНрдордХ рдпреЛрдЧ (рдЬреИрд╕реЗ рдЧрдЬрдХреЗрд╕рд░реА, рдмреБрджреНрдзрд╛рджрд┐рддреНрдп, рд▓рдХреНрд╖реНрдореА рдпреЛрдЧ рдЖрджрд┐)
   - рдирдХрд╛рд░рд╛рддреНрдордХ рдпреЛрдЧ рдпрд╛ рдХрдордЬреЛрд░ рдЧреНрд░рд╣ рд╕реНрдерд┐рддрд┐
   - рдЧреНрд░рд╣реЛрдВ рдХреА рджреГрд╖реНрдЯрд┐рдпрд╛рдБ рдФрд░ рдЧреЛрдЪрд░ рдХрд╛ рдкреНрд░рднрд╛рд╡

3. **рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рдВрдмрдВрдзреА рд╕рдВрднрд╛рд╡рдирд╛рдПрдБ:**
   - рдорд╛рдирд╕рд┐рдХ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреА рд╕реНрдерд┐рддрд┐ (рдЬреИрд╕реЗ рдЪрд┐рдВрддрд╛, рдЕрд╡рд╕рд╛рдж рдЖрджрд┐)
   - рд╢рд╛рд░реАрд░рд┐рдХ рд░реЛрдЧреЛрдВ рдХреА рд╕рдВрднрд╛рд╡рдирд╛рдПрдБ (рдЬреИрд╕реЗ рддреНрд╡рдЪрд╛, рдкрд╛рдЪрди, рд░рдХреНрддрдЪрд╛рдк рдЖрджрд┐)
   - рдХреМрди рд╕реЗ рдЧреНрд░рд╣ рдпрд╛ рднрд╛рд╡ рдЗрдирд╕реЗ рдЬреБрдбрд╝реЗ рд╣реИрдВ?

4. **рдЬреАрд╡рди рдХреЗ рдкреНрд░рдореБрдЦ рдХреНрд╖реЗрддреНрд░:**
   - рд╡рд┐рд╡рд╛рд╣ рдФрд░ рджрд╛рдВрдкрддреНрдп рдЬреАрд╡рди
   - рдХрд░рд┐рдпрд░ рдФрд░ рдЖрд░реНрдерд┐рдХ рд╕реНрдерд┐рддрд┐
   - рд╢рд┐рдХреНрд╖рд╛, рдпрд╛рддреНрд░рд╛ рдФрд░ рд╕рдВрддрд╛рди in fully details
   - рдкрд╛рд░рд┐рд╡рд╛рд░рд┐рдХ рд╕рдВрдмрдВрдз рдФрд░ рд╕рд╛рдорд╛рдЬрд┐рдХ рдЬреАрд╡рди
5. **рднрд╡рд┐рд╖реНрдпрд╡рд╛рдгреА рдФрд░ рд╕рд▓рд╛рд╣:**
   - рдЕрдЧрд▓реЗ 1-2 рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдХреНрдпрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдШрдЯрдирд╛рдПрдБ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ?

5. **рдЙрдкрд╛рдп рдФрд░ рд╕рдорд╛рдзрд╛рди:**
   - рдХреМрди-рдХреМрди рд╕реЗ рдордВрддреНрд░ рдЬрд╛рдк рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП?
   - рдХреМрди-рд╕реЗ рд░рддреНрди рдзрд╛рд░рдг рдХрд░рдирд╛ рд▓рд╛рднрдХрд╛рд░реА рд╣реЛрдЧрд╛?
   - рдХреМрди-рд╕реЗ рджрд╛рди рдФрд░ рдкреВрдЬрд╛ рдЙрдкрд╛рдп рдХрд┐рдП рдЬрд╛рдПрдБ?

ЁЯТм рдХреГрдкрдпрд╛ рдЙрддреНрддрд░ рдкреВрд░реА рддрд░рд╣ рд╕реЗ **рд╣рд┐рдВрджреА рднрд╛рд╖рд╛** рдореЗрдВ рджреЗрдВред рд╕рд░рд▓, рд╕реНрдкрд╖реНрдЯ рдФрд░ рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рджрд╛рди рдХрд░реЗрдВ, рдЬрд┐рд╕рд╕реЗ рд╡реНрдпрдХреНрддрд┐ рдЙрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рд╕рдордЭ рдФрд░ рдЕрдиреБрд╕рд░рдг рдХрд░ рд╕рдХреЗред

рдЙрддреНрддрд░ рдХреЛ **рд╕реВрдЪреАрдмрджреНрдз (bullet points)** рдФрд░ **рд╡рд░реНрдЧреАрдХреГрдд (sections)** рд░реВрдк рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХрд░реЗрдВред рдмрд┐рдирд╛ рдХрд┐рд╕реА рдЕрдирд╛рд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рдХреЗрд╡рд▓ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдФрд░ рдЬреНрдпреЛрддрд┐рд╖реАрдп рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдЙрдкрдпреЛрдЧреА рд╕реБрдЭрд╛рд╡ рджреЗрдВред
`;


    const result = await model.generateContent(prompt);
    const suggestion = result.response.text();

    const saved = await Astrology.create({
      name,
      birthDate,
      birthTime,
      birthPlace,
      suggestion,
    });

    res.status(200).json(saved);
  } catch (err) {
    console.error("Gemini AI Error:", err);
    res.status(500).json({ error: "Failed to generate astrology report." });
  }
};
